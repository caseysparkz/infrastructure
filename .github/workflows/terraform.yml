# Author:       Casey Sparks
# Date:         August 16, 2024
# Description:  Run `terraform validate` against new terraform configs.
# TODO:
#               * `infracost breakdown`
#               * `tf plan`
#               * `tf apply`
---
name: "Terraform"
on:
  pull_request:
    branches: ["main"]
    paths:
      - "**/*.tf"
      - "**/*.tf.json"
      - "**/*.tftest.hcl"
      - "**/*.tftpl"
      - "**/*.tfvars"
      - "**/*.tfvars.json"
      - "**/tfvars/**"
      - ".github/workflows/terraform.yml"
  push:
    branches: ["main"]
    paths:
      - "**/*.tf"
      - "**/*.tf.json"
      - "**/*.tftest.hcl"
      - "**/*.tftpl"
      - "**/*.tfvars"
      - "**/*.tfvars.json"
      - "**/tfvars/**"
env:
  TF_VER: "1.14.3"  # Increment to update terraform version
jobs:
  terraform_validate:
    name: "Terraform Validate"
    runs-on: "ubuntu-latest"
    permissions:
      contents: "read"
    strategy:
      matrix:
        work_dir:
          - "./com/caseysparkz/"
          - "./com/caseysparkz/ecr/"
          - "./com/caseysparkz/home/"
          - "./com/caseysparkz/store/"
          - "./com/caseysparkz/www/"
          - "./tfstate/"
          # Modules. Update with each addition.
          - "./modules/cloudflare_dns_zone/"
          - "./modules/ecr/"
          - "./modules/forward_zones/"
          - "./modules/hugo_static_site/"
          - "./modules/proton_domain/"
          - "./modules/s3_artifacts/"
    defaults:
      run:
        working-directory: "${{ matrix.work_dir }}"
    steps:
      - name: "git checkout"
        uses: "actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8"  # v6.0.1
        with:
          fetch-depth: 0

      - name: "Set up Terraform"
        uses: "hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd"  # v3.1.2
        with:
          terraform_version: "${{ env.TF_VER }}"

      - name: "terraform init"
        run: "terraform init --upgrade --backend=false"

      - name: "terraform validate"
        run: "terraform validate"

  infracost_breakdown:
    name: "Add Infracost breakdown to pull request"
    if: "github.event_name == 'pull_request'"
    runs-on: "ubuntu-latest"
    needs: ["terraform_validate"]
    permissions:
      contents: "read"
      pull-requests: "write"
    steps:
      - name: "git checkout"
        uses: "actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8"  # v6.0.1
        with:
          fetch-depth: 0
          ref: "${{ github.event.pull_request.base.ref }}"

      - name: "Setup Infracost"
        uses: "infracost/actions/setup@e9d6e6cd65e168e76b0de50ff9957d2fe8bb1832"  # v3.0.1
        with:
          api-key: "${{ secrets.INFRACOST_API_KEY }}"
          github-token: "${{ github.token }}"

      - name: "infracost breakdown (baseline)"
        run: >
          infracost breakdown
            --config-file infracost.yml
            --format json
            --out-file /tmp/infracost_base.json"

      - name: "git checkout (pr branch)"
        uses: "actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8"  # v6.0.1
        with:
          fetch-depth: 0

      - name: "infracost diff"
        run: >
          infracost diff
            --config-file infracost.yml
            --format json
            --compare-to /tmp/infracost_base.json
            --out-file /tmp/infracost_diff.json

      - name: "infracost comment"
        run: >
          infracost comment github
            --path /tmp/infracost_diff.json
            --repo ${{ github.repository }}
            --pull-request ${{ github.event.pull_request.number }}
            --github-token ${{ github.token }}
            --behavior hide-and-new

  terraform_plan:
    name: "Terraform Plan"
    if: "github.event_name == 'pull_request'"
    runs-on: "ubuntu-latest"
    needs: ["terraform_validate"]
    permissions:
      contents: "write"
    strategy:
      matrix:
        work_dir:
          - "./com/caseysparkz/"
          - "./com/caseysparkz/ecr/"
          - "./com/caseysparkz/home/"
          - "./com/caseysparkz/store/"
          - "./com/caseysparkz/www/"
          - "./tfstate/"
    defaults:
      run:
        working-directory: "${{ matrix.work_dir }}"
    steps:
      - name: "git checkout"
        uses: "actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8"  # v6.0.1
        with:
          fetch-depth: 1

      - name: "aws configure"
        uses: "aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708"  # v5.1.1
        with:
          aws-access-key-id: "${{ secrets.AWS_ACCESS_KEY_ID}}"
          aws-secret-access-key: "${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          aws-region: "${{ secrets.AWS_REGION }}"

      - name: "Set up Terraform"
        uses: "hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd"  # v3.1.2
        with:
          terraform_version: "${{ env.TF_VER }}"

      - name: "terraform init"
        run: "terraform init --upgrade"

      - name: "teraform plan"
        run: "terraform plan --var-file production.tfvars --out planfile"

      - name: "Cache Terraform plan"
        uses: "actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7"  # v5.0.2
        with:
          path: "/tmp/production.tfplan"
          key: "${{ matrix.workdir}}/production.tfplan"

      - name: "gh pr comment"
        uses: "borchero/terraform-plan-comment@5461c89b054077416f3220bac9089c6093483020"  # v2.6.0
        with:
          token: "${{ github.token }}"
          planfile: "planfile"

# ========================= HOLD UNTIL READY FOR CD ===========================
# terraform_plan needs to cache the planfile
# terraform_apply needs to retrieve the planfile from cache and apply it
# -----------------------------------------------------------------------------
# terraform_apply:
#   name: "Terraform Apply"
#   if: "github.event_name == 'push'"
#   runs-on: "ubuntu-latest"
#   strategy:
#     matrix:
#       work_dir:
#         - "./com/caseysparkz/"
#         - "./com/caseysparkz/ecr/"
#         - "./com/caseysparkz/store/"
#         - "./com/caseysparkz/www/"
#         - "./tfstate/"
#   defaults:
#     run:
#       working-directory: "${{ matrix.work_dir }}"
#   steps:
#     - name: "Checkout"
#       uses: "actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8"  # v 6.0.1
#       with:
#         fetch-depth: 0

#     - name: "Log in to AWS CLI"
#       uses: "aws-actions/configure-aws-credentials@b47578312673ae6fa5b5096b330d9fbac3d116df"  # v4.3.1
#       with:
#         aws-access-key-id: "${{ secrets.AWS_ACCESS_KEY_ID}}"
#         aws-secret-access-key: "${{ secrets.AWS_SECRET_ACCESS_KEY }}"
#         aws-region: "${{ secrets.AWS_REGION }}"

#     - name: "Set up Terraform"
#       uses: "hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd"  # v3.1.2
#       with:
#         terraform_version: "${{ env.TF_VER }}"

#     - name: "Initialize Terraform."
#       run: "terraform init --upgrade --backend false"

#     - name: "Retrieve Terraform plan"
#       uses: "actions/cache/restore@5a3ec84eff668545956fd18022155c47e93e2684"  # v4.2.3
#       with:
#         path: "/tmp/production.tfplan"
#         key: "${{ matrix.workdir}}/production.tfplan"

#     - name: "Terraform apply"
#       run: "terraform apply --var-file=production.tfvars --auto-approve /tmp/production.tfplan"
